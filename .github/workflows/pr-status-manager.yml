# .github/workflows/pr-lifecycle.yml

name: 'PR Lifecycle Manager'

on:
  pull_request:
    types: [opened, ready_for_review, assigned, closed]

jobs:
  manage-pr:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write # Права на управление метками
      contents: write      # Права на удаление веток

    steps:
      # --- Шаг 1: Назначение и запрос отзыва при открытии PR ---
      - name: Assign and request review on open
        if: github.event.action == 'opened' || github.event.action == 'ready_for_review'
        uses: actions/github-script@v6
        with:
          script: |
            const { owner, repo } = context.repo;
            const pr = context.payload.pull_request;

            // --- НАСТРОЙКИ ---
            const ASSIGNEE_USERNAME = 'YOUR_USERNAME'; 
            const REVIEWER_USERNAME = 'REVIEWER_USERNAME'; 
            // -----------------

            // Назначаем ответственного
            if (ASSIGNEE_USERNAME !== 'YOUR_USERNAME') {
              await github.rest.issues.addAssignees({ owner, repo, issue_number: pr.number, assignees: [ASSIGNEE_USERNAME] });
            }

            // Запрашиваем ревью
            if (REVIEWER_USERNAME !== 'REVIEWER_USERNAME') {
              await github.rest.pulls.requestReviewers({ owner, repo, pull_number: pr.number, reviewers: [REVIEWER_USERNAME] });
            }
            
            // Добавляем статус "нужен обзор"
            await github.rest.issues.addLabels({ owner, repo, issue_number: pr.number, labels: ["статус: нужен обзор"] });

      # --- Шаг 2: Управление статусами при назначении ---
      - name: Set 'in progress' on assign
        if: github.event.action == 'assigned'
        uses: actions-ecosystem/action-add-labels@v1
        with:
          labels: статус: в работе
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Remove 'needs review' on assign
        if: github.event.action == 'assigned'
        uses: actions-ecosystem/action-remove-labels@v1
        with:
          labels: статус: нужен обзор
          github_token: ${{ secrets.GITHUB_TOKEN }}

      # --- Шаг 3: Управление статусами и удаление ветки при закрытии ---
      - name: Handle PR close (merge or reject)
        if: github.event.action == 'closed'
        uses: actions/github-script@v6
        with:
          script: |
            const { owner, repo } = context.repo;
            const pr = context.payload.pull_request;
            const isMerged = pr.merged;
            
            const finalLabel = isMerged ? "статус: сделано" : "статус: отклонено";
            await github.rest.issues.addLabels({ owner, repo, issue_number: pr.number, labels: [finalLabel] });
            
            const labelsToRemove = ["статус: нужен обзор", "статус: в работе"];
            for (const label of labelsToRemove) {
              await github.rest.issues.removeLabel({ owner, repo, issue_number: pr.number, name: label }).catch(() => {});
            }

      - name: Delete branch after merge
        if: github.event.action == 'closed' && github.event.pull_request.merged == true
        uses: dawidd6/action-delete-branch@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branches: ${{ github.head_ref }}
