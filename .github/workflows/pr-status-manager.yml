name: 'PR Status Manager'

on:
  pull_request:
    types: [opened, ready_for_review, closed]

jobs:
  manage-status:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write

    steps:
      - name: Manage Status Labels
        uses: actions/github-script@v6
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const pr_number = context.payload.pull_request.number;

            const addLabel = (label) => github.rest.issues.addLabels({ owner, repo, issue_number: pr_number, labels: [label] });
            // .catch(() => {}) нужен, чтобы скрипт не падал с ошибкой, если пытается удалить несуществующую метку
            const removeLabel = (label) => github.rest.issues.removeLabel({ owner, repo, issue_number: pr_number, name: label }).catch(() => {});

            if (context.payload.action === 'opened' || context.payload.action === 'ready_for_review') {
              const currentLabels = context.payload.pull_request.labels.map(l => l.name);
              if (!currentLabels.includes("статус: в работе")) {
                await addLabel("статус: нужен обзор");
              }
            } else if (context.payload.action === 'closed') {
              // Сначала удаляем промежуточные статусы
              await removeLabel("статус: нужен обзор");
              await removeLabel("статус: в работе");

              // Затем добавляем финальный статус
              if (context.payload.pull_request.merged) {
                await addLabel("статус: сделано");
              } else {
                await addLabel("статус: отклонено");
              }
            }
              for (const labelToRemove of labelsToRemove) {
                if (currentLabels.includes(labelToRemove)) {
                  await github.rest.issues.removeLabel({
                    owner,
                    repo,
                    issue_number: pr_number,
                    name: labelToRemove
                  });
                }
              }
            }

            if (context.payload.action === 'opened' || context.payload.action === 'ready_for_review') {
              const currentLabels = pull_request.labels.map(l => l.name);
              if (!currentLabels.includes("статус: в работе")) {
                await setStatusLabel("статус: нужен обзор");
              }

            } else if (context.payload.action === 'closed') {
              if (pull_request.merged) {
                await setStatusLabel("статус: сделано");
              } else {
                await setStatusLabel("статус: отклонено");
              }
            }
