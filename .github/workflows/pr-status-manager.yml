name: 'PR Status Manager'

on:
  pull_request:
    types: [opened, ready_for_review, closed]

jobs:
  manage-status:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write

    steps:
      - name: Manage Status Labels
        uses: actions/github-script@v6
        with:
          script: |
            const { owner, repo } = context.repo;
            const issue_number = context.payload.pull_request.number;
            const action = context.payload.action;
            const is_merged = context.payload.pull_request.merged;
            const current_labels = context.payload.pull_request.labels.map(l => l.name);

            if (action === 'opened' || action === 'ready_for_review') {
              if (!current_labels.includes("статус: в работе")) {
                github.rest.issues.addLabels({ owner, repo, issue_number, labels: ["статус: нужен обзор"] });
              }
            }

            if (action === 'closed') {
              const finalLabel = is_merged ? "статус: сделано" : "статус: отклонено";
              github.rest.issues.addLabels({ owner, repo, issue_number, labels: [finalLabel] });

              // Используем .catch() чтобы предотвратить ошибку, если метка уже удалена
              github.rest.issues.removeLabel({ owner, repo, issue_number, name: "статус: нужен обзор" }).catch(() => {});
              github.rest.issues.removeLabel({ owner, repo, issue_number, name: "статус: в работе" }).catch(() => {});
            }
