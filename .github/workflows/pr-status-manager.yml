name: 'PR Status Manager'

on:
  pull_request:
    types: [opened, ready_for_review, closed]

jobs:
  manage-status:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write

    steps:
      - name: Manage Status Labels
        uses: actions/github-script@v6
        with:
          script: |
            const { owner, repo } = context.repo;
            const issue_number = context.payload.pull_request.number;
            const action = context.payload.action;
            const is_merged = context.payload.pull_request.merged;

            if (action === 'opened' || action === 'ready_for_review') {
              const currentLabels = context.payload.pull_request.labels.map(l => l.name);
              if (!currentLabels.includes("статус: в работе")) {
                await github.rest.issues.addLabels({ owner, repo, issue_number, labels: ["статус: нужен обзор"] });
              }
            }

            if (action === 'closed') {
              const finalLabel = is_merged ? "статус: сделано" : "статус: отклонено";
              await github.rest.issues.addLabels({ owner, repo, issue_number, labels: [finalLabel] });

              const labelsToRemove = ["статус: нужен обзор", "статус: в работе"];
              for (const labelToRemove of labelsToRemove) {
                await github.rest.issues.removeLabel({ owner, repo, issue_number, name: labelToRemove }).catch(() => {});
              }
            }
