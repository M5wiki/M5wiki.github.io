name: 'PR Size Labeler'

on:
  pull_request:
    types: [opened, synchronize, ready_for_review]

jobs:
  label-size:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write

    steps:
      - name: Add size label
        uses: actions/github-script@v6
        with:
          script: |
            const { owner, repo } = context.repo;
            const pr = context.payload.pull_request;
            
            const SIZE_SMALL_THRESHOLD = 50;
            const SIZE_MEDIUM_THRESHOLD = 200;
            
            const additions = pr.additions || 0;
            const deletions = pr.deletions || 0;
            const totalChanges = additions + deletions;
            
            let newSizeLabel = 'размер: малый';
            if (totalChanges > SIZE_MEDIUM_THRESHOLD) {
              newSizeLabel = 'размер: большой';
            } else if (totalChanges > SIZE_SMALL_THRESHOLD) {
              newSizeLabel = 'размер: средний';
            }
            
            const allSizeLabels = ['размер: малый', 'размер: средний', 'размер: большой'];
            const currentLabels = pr.labels.map(l => l.name);
            
            for (const oldSizeLabel of allSizeLabels) {
              if (currentLabels.includes(oldSizeLabel) && oldSizeLabel !== newSizeLabel) {
                await github.rest.issues.removeLabel({ owner, repo, issue_number: pr.number, name: oldSizeLabel });
              }
            }
            
            if (!currentLabels.includes(newSizeLabel)) {
              await github.rest.issues.addLabels({ owner, repo, issue_number: pr.number, labels: [newSizeLabel] });
            }
